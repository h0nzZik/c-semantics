include $(dir $(lastword $(MAKEFILE_LIST)))/../.build/inc.mk
include definitions.mk


.PHONY: default
default: help

.PHONY: help
help:
	@echo 'List of variables:'
	@echo '  PROFILES_DIR (mandatory)'
	@echo '  KOMPILE_FLAGS (mandatory)'
	@echo
	@echo 'Format of targets:'
	@echo '  ./build/x86-gcc-limited-libc/$(call timestampOf,$$(lang)/$$(variant))'
	@echo '  where $$(lang) in $(LANGUAGE_DEFS)' 
	@echo '  and $$(variant): any'
	@echo
	@echo 'Example target:'
	@echo '  ./build/x86-gcc-limited-libc/$(call timestampOf,c-cpp-execution/nd)'
	@echo


# Parameter: PROFILES_DIR

OPAQUE_KLABELS = --opaque-klabels c-translation.k


KOMPILE_DEFAULT_FLAGS = --backend ocaml \
                        --non-strict \
                        --smt none \
                        $(OPAQUE_KLABELS)

# Naming scheme:
# .build/$(PROFILE_NAME)/$(DEFINITION)/$(VARIANT)/$(DEFINITION)-kompiled/timestamp
# We also provide a symlinked directory:
# ./build/$(PROFILE)/$(DEFINITION)/$(VARIANT)/kompiled/


.build/%/timestamp:
	$(call setCurrentVars,$@)
	$(eval CURRENT_PROFILE_DIR := $(PROFILES_DIR)/$(CURRENT_PROFILE_NAME))
	@#echo 'CURRENT_PROFILE_DIR: $(CURRENT_PROFILE_DIR)'
	@#echo 'Kompiling $(CURRENT_DEFINITION)/$(CURRENT_VARIANT)'

	$(KOMPILE) \
		$(KOMPILE_FLAGS) \
        	$(KOMPILE_DEFAULT_FLAGS) \
		-I $(PROFILE_DIR)/semantics \
		--no-prelude -w all -v --debug \
		$(CURRENT_DEFINITION).k \	
		-d $(CURRENT_BUILD_DIR)

	ln -s '$(CURRENT_DEFINITION)-kompiled' '$(CURRENT_BUILD_DIR)/kompiled'



